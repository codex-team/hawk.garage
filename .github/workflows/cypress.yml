name: Cypress testing

on: [push]

jobs:
  e2e:
    runs-on: ubuntu-latest

    container:
      image: cypress/browsers:node14.16.0-chrome89-ff86

    services:
      mongodb:
        image: mongo
        ports:
          - 27017:27017

      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 15672:15672

      api:
        image: codexteamuser/hawk-api:stage
        ports:
          - 4000:4000
        env:
          NODE_ENV: e2e
        options: >-
          --health-cmd "curl -f http://localhost:8080/auth/realms/master"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
          --health-start-period 30s

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v2

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install deps
        run: yarn

      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          browser: chrome
          start: yarn serve
          config-file: cypress.e2e.json
          env: VUE_APP_API_ENDPOINT=http://api:4000,VUE_APP_CLOUDPAYMENTS_PUBLIC_ID=test_api_00000000000000000000001

